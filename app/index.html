<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <base target="_top">
    <style>
     /*
      #myemailaddress, input[type=text], input[type=email], input[type=number], textarea {
        color: green;
      }
      img {
        border: 5px solid green;
      }
     */
    </style>
    <script src="https://cdn.ckeditor.com/4.14.0/full/ckeditor.js"></script>
    <!--
       The following JS function call was seemingly not required:
       <script>
           CKEDITOR.plugins.addExternal( 'confighelper', '/plugins/confighelper', 'plugin.js' );
       </script>
    -->
    <script>
      // Prevent forms from submitting.
      function preventFormSubmit() {
          var forms = document.querySelectorAll('form');
          for (var i = 0; i < forms.length; i++) {
              forms[i].addEventListener('submit', function(event) {
                  event.preventDefault();
              });
          }
      }
      window.addEventListener('load', preventFormSubmit);
    
    
      // Load settings from backend
      function onObjGetSuccess(settings) {
        document.getElementById("userphoto").innerHTML = '<img src="' + settings['userPhotoUrl'] + '" alt="User Photo">';
        document.getElementById("myemailaddress").textContent = settings['userEmail'];
        document.getElementById("revokeAccessLink").innerHTML = '<em>\
            (<a href="https://security.google.com/settings/security/permissions" target="_blank">Revoke access</a>)\
            </em>';
        document.getElementById("filtersssid").value = settings['filtersssid'];
        document.getElementById("logsssid").value = settings['logsssid'];
        document.getElementById("starthour").value = parseInt(settings['starthour'], 10);
        document.getElementById("finishhour").value = parseInt(settings['finishhour'], 10);
        document.getElementById("dstoffset").value = parseInt(settings['dstoffset'], 10);
        document.getElementById("ccemailadr").value = settings['ccemailadr'];
        document.getElementById("bccemailadr").value = settings['bccemailadr'];
        
        //console.log("[DEBUG/GET] settings[\'noreply\'] === " + settings['noreply'] + ", of type : " + typeof(settings['noreply']));
        switch(settings['noreply']) {
          case "YES":
            document.getElementById("yes_noreply").checked = true;
            break;
          case "NO":
            document.getElementById("no_noreply").checked = true;
            break;
          case "N_A":
            document.getElementById("yes_noreply").disabled = true;
            document.getElementById("no_noreply").disabled = true;
            break;
          default:
            document.getElementById("no_noreply").checked = true;
        }
        
        //console.log("[DEBUG/GET] settings[\'starmsg\'] === " + settings['starmsg'] + ", of type : " + typeof(settings['starmsg']));
        switch(settings['starmsg']) {
          case "NO":
            document.getElementById("no_starmsg").checked = true;
            break;
          default:
            document.getElementById("yes_starmsg").checked = true;
        }
        
        CKEDITOR.instances["msgbody"].setData(settings['msgbody'], {
              callback: function() {
              this.checkDirty(); // true
          }});
          
        //alert("Settings loaded successfully!");
      }
      
      // Run on 'Set' (Save) or 'Get' (Load) failure
      function onFailure(error) {
        alert("ERROR : " + error.message);
      }
      
      // Load settings on page load
      /**
      google.script.run
           .withSuccessHandler(onObjGetSuccess)
           .withFailureHandler(onFailure)
           .getSettings();
      **/
    
      // Run on 'Set' (Save) success
      function onSetSuccess(settings) {
        alert("Settings updated successfully!");
      }
      
      // Save settings to backend 
      function saveSettings(formObject) {
         //➜ Process formObject.elements["noreply"].value
         /*console.log("[DEBUG/SET] formObject.elements[\"noreply\"].value === " 
                      + formObject.elements["noreply"].value 
                      + ", of type : " + typeof(formObject.elements["noreply"].value ));*/
                      
         //➜ Process formObject.elements["starmsg"].value
         /*console.log("[DEBUG/SET] formObject.elements[\"starmsg\"].value === " 
                      + formObject.elements["starmsg"].value 
                      + ", of type : " + typeof(formObject.elements["starmsg"].value ));*/
         CKEDITOR.instances['msgbody'].updateElement();
         google.script.run
              .withSuccessHandler(onSetSuccess)
              .withFailureHandler(onFailure)
              .setProperties(formObject)
      }
    </script>
    <title>Gmail AutoResponder</title>
  </head>
  <body>
    <h2>Gmail AutoResponder</h2>
                    
    <input type="button" value="Load Settings" 
           onclick="google.script.run
                    .withSuccessHandler(onObjGetSuccess)
                    .withFailureHandler(onFailure)
                    .getSettings()" /><br /><br />
  
    <div id="userphoto"></div> <br />
    
    <strong>Logged in as : </strong><span id="myemailaddress"></span> <span id="revokeAccessLink"></span> <br /><br />
    
    <form id="gmasettings" onsubmit="saveSettings(this)">
      <fieldset>
        <legend>Settings</legend>
        Filters Spreadsheet ID : <input id="filtersssid" name="filtersssid" type="text" /><br /><br />
        Logs Spreadsheet ID : <input id="logsssid" name="logsssid" type="text" /><br /><br />
        Start Hour : <input id="starthour" name="starthour" type="number" /><em> (default: 17)</em><br /><br />
        Finish Hour : <input id="finishhour" name="finishhour" type="number" /><em> (default: 8)</em><br /><br />
        Daylight Saving Time Offset : <input id="dstoffset" name="dstoffset" type="number" /><em> (default: 0)</em><br /><br />
        Cc Email Address : <input id="ccemailadr" name="ccemailadr" type="email" /><br /><br />
        Bcc Email Address : <input id="bccemailadr" name="bccemailadr" type="email" /><br /><br />
        Reply with 'noreply' address? 
           <input type="radio" name="noreply" id="yes_noreply" value="YES"> Yes 
           <input type="radio" name="noreply" id="no_noreply" value="NO"> No <br /><br />
        Star processed messages in Gmail 
           <input type="radio" name="starmsg" id="yes_starmsg" value="YES"> Yes 
           <input type="radio" name="starmsg" id="no_starmsg" value="NO"> No <br /><br />
        Message Body : <br /><br />
           <textarea cols="80" id="msgbody" name="msgbody" rows="10" placeholder="𝘈𝘶𝘵𝘰𝘮𝘢𝘵𝘦𝘥 𝘳𝘦𝘴𝘱𝘰𝘯𝘴𝘦 : 
           𝘛𝘩𝘢𝘯𝘬 𝘺𝘰𝘶 𝘧𝘰𝘳 𝘤𝘰𝘯𝘵𝘢𝘤𝘵𝘪𝘯𝘨 𝘶𝘴. 𝘛𝘩𝘪𝘴 𝘢𝘶𝘵𝘰𝘮𝘢𝘵𝘦𝘥 𝘳𝘦𝘴𝘱𝘰𝘯𝘴𝘦 𝘪𝘴 𝘰𝘯𝘭𝘺 𝘵𝘰 𝘤𝘰𝘯𝘧𝘪𝘳𝘮 𝘵𝘩𝘢𝘵 𝘺𝘰𝘶𝘳 𝘦-𝘮𝘢𝘪𝘭 𝘩𝘢𝘴 𝘣𝘦𝘦𝘯 𝘸𝘦𝘭𝘭 𝘳𝘦𝘤𝘦𝘪𝘷𝘦𝘥. 
           𝘞𝘦 𝘸𝘪𝘭𝘭 𝘳𝘦𝘱𝘭𝘺 𝘵𝘰 𝘺𝘰𝘶 𝘴𝘩𝘰𝘳𝘵𝘭𝘺. 𝘉𝘦𝘴𝘵 𝘳𝘦𝘨𝘢𝘳𝘥𝘴."></textarea><br /><br />
        <input type="submit" value="Save" />
      </fieldset>
    </form>
    
    <script>
        // Consider using an alternative safe/permanent external URL of the plugin
        CKEDITOR.plugins.addExternal( 'confighelper', 'https://martinezdelizarrondo.com/ckplugins/confighelper/' );

        var config = {
          extraPlugins: 'confighelper',
          toolbarGroups: [
            { "name": "clipboard", "groups": [ "undo" ] },
            { "name": "styles", "groups": [ "styles" ] },
            { "name": "basicstyles", "groups": ["basicstyles"] },
            { "name": "colors", "groups": [ "colors" ] },
            { "name": "paragraph", "groups": ["list", "blocks", "indent"] },
            { "name": "links", "groups": ["links"] },
            //{ "name": "documents", "groups": ["mode"] }
          ],
          removeButtons: 'Strike,Subscript,Superscript,Anchor,Styles,Specialchar,PasteFromWord,PasteText,Paste,Copy,Cut,CreateDiv,FontSize'
        };

        CKEDITOR.replace('msgbody', config);
    </script>
  </body>
</html>
